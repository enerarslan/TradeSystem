# =============================================================================
# RISK MANAGEMENT PARAMETERS - INSTITUTIONAL GRADE
# JPMorgan-Level Risk Controls
# =============================================================================

# =============================================================================
# PORTFOLIO-LEVEL RISK PARAMETERS
# =============================================================================
portfolio_risk:
  # Capital allocation
  capital:
    initial_capital: 1000000.0
    reserved_cash_pct: 0.05  # 5% always in cash
    max_leverage: 1.0  # No leverage (1.0 = fully invested)
    margin_requirement: 0.25  # 25% margin requirement

  # Drawdown controls
  drawdown:
    max_drawdown_pct: 0.10  # 10% max portfolio drawdown
    drawdown_recovery_mode: true  # Reduce position sizes during recovery
    recovery_reduction_factor: 0.5  # 50% size reduction during recovery
    trailing_drawdown_period: 20  # Rolling 20-period drawdown check

  # Loss limits
  loss_limits:
    daily_loss_limit_pct: 0.02  # 2% daily loss limit
    weekly_loss_limit_pct: 0.05  # 5% weekly loss limit
    monthly_loss_limit_pct: 0.08  # 8% monthly loss limit
    consecutive_loss_days_halt: 3  # Halt after 3 consecutive losing days

  # Value at Risk (VaR)
  var:
    confidence_level: 0.99  # 99% VaR
    lookback_days: 252  # 1 year historical VaR
    daily_var_limit_pct: 0.015  # 1.5% daily VaR limit
    method: "historical"  # historical, parametric, monte_carlo

  # Expected Shortfall (CVaR)
  cvar:
    enabled: true
    confidence_level: 0.95
    limit_pct: 0.025  # 2.5% CVaR limit

# =============================================================================
# POSITION-LEVEL RISK PARAMETERS
# =============================================================================
position_risk:
  # Position sizing
  sizing:
    max_position_pct: 0.05  # 5% max per position
    min_position_pct: 0.005  # 0.5% min position
    max_position_value: 50000  # $50K max per position
    min_position_value: 1000  # $1K min per position

  # Position limits by category
  category_limits:
    max_single_stock: 0.05  # 5% max single stock
    max_sector_exposure: 0.25  # 25% max sector
    max_industry_exposure: 0.15  # 15% max industry
    max_correlated_positions: 0.40  # 40% max correlated group

  # Stop loss parameters
  stop_loss:
    enabled: true
    default_stop_pct: 0.02  # 2% stop loss
    volatility_adjusted: true  # Adjust stop based on ATR
    atr_multiplier: 2.0  # Stop = entry - 2 * ATR
    max_stop_pct: 0.05  # Max 5% stop loss
    min_stop_pct: 0.01  # Min 1% stop loss

  # Take profit parameters
  take_profit:
    enabled: true
    default_tp_pct: 0.04  # 4% take profit
    risk_reward_min: 1.5  # Minimum 1.5:1 reward:risk
    partial_profit_enabled: true
    partial_profit_levels:
      - level: 0.02  # 2% profit
        exit_pct: 0.33  # Exit 33%
      - level: 0.03  # 3% profit
        exit_pct: 0.33  # Exit another 33%
      - level: 0.04  # 4% profit
        exit_pct: 0.34  # Exit remaining

  # Trailing stop
  trailing_stop:
    enabled: true
    activation_pct: 0.015  # Activate after 1.5% profit
    trail_pct: 0.01  # 1% trailing stop
    step_mode: false  # Continuous trailing

# =============================================================================
# VOLATILITY-BASED RISK ADJUSTMENTS
# =============================================================================
volatility_risk:
  # Target volatility
  target:
    annual_volatility: 0.15  # 15% target annual volatility
    volatility_lookback: 20  # 20-period volatility lookback
    volatility_scaling: true  # Scale positions by volatility

  # Volatility regime detection
  regime:
    low_vol_threshold: 0.10  # Below 10% = low vol
    high_vol_threshold: 0.25  # Above 25% = high vol
    extreme_vol_threshold: 0.40  # Above 40% = extreme

  # Regime-based adjustments
  adjustments:
    low_vol:
      position_multiplier: 1.2  # 20% larger positions
      stop_multiplier: 0.8  # Tighter stops
    normal_vol:
      position_multiplier: 1.0
      stop_multiplier: 1.0
    high_vol:
      position_multiplier: 0.7  # 30% smaller positions
      stop_multiplier: 1.5  # Wider stops
    extreme_vol:
      position_multiplier: 0.3  # 70% smaller positions
      stop_multiplier: 2.0  # Much wider stops
      max_new_positions: 0  # No new positions

# =============================================================================
# CORRELATION & CONCENTRATION RISK
# =============================================================================
correlation_risk:
  # Correlation limits
  limits:
    max_pairwise_correlation: 0.70  # Max 70% correlation between positions
    max_portfolio_correlation: 0.60  # Max 60% avg portfolio correlation
    correlation_lookback: 60  # 60-period correlation lookback

  # Correlation-based position limits
  position_adjustment:
    high_correlation_threshold: 0.80
    high_correlation_reduction: 0.5  # 50% size reduction for highly correlated

  # Sector concentration
  sector_limits:
    technology: 0.30  # 30% max tech
    financials: 0.25
    healthcare: 0.25
    consumer_discretionary: 0.25
    consumer_staples: 0.20
    industrials: 0.20
    energy: 0.15
    communication_services: 0.15
    default: 0.20

# =============================================================================
# LIQUIDITY RISK
# =============================================================================
liquidity_risk:
  # Volume constraints
  volume:
    max_participation_rate: 0.02  # Max 2% of daily volume
    min_daily_volume: 100000  # Min 100K daily volume
    volume_lookback: 20  # 20-day avg volume

  # Spread constraints
  spread:
    max_spread_bps: 50  # Max 50 bps spread
    spread_adjusted_sizing: true  # Reduce size for wide spreads

  # Market impact
  impact:
    impact_model: "square_root"  # square_root, linear
    max_impact_bps: 10  # Max 10 bps market impact

# =============================================================================
# CIRCUIT BREAKERS
# =============================================================================
circuit_breakers:
  # Trade limits
  trade_limits:
    max_daily_trades: 100
    max_hourly_trades: 20
    max_trades_per_symbol: 5

  # Loss triggers
  loss_triggers:
    consecutive_losses_halt: 5  # Halt after 5 consecutive losses
    win_rate_threshold: 0.30  # Halt if win rate < 30%
    win_rate_period: 20  # Over last 20 trades
    # CRITICAL FIX: Added tighter intraday circuit breaker
    intraday_loss_circuit_breaker: 0.03  # 3% intraday loss triggers circuit breaker
    intraday_loss_warning: 0.010  # 1% intraday loss triggers warning & reduced sizing

  # Volatility triggers
  volatility_triggers:
    vix_halt_threshold: 40  # Halt if VIX > 40
    intraday_move_halt: 0.03  # Halt if market moves 3% intraday
    symbol_halt_threshold: 0.10  # Halt symbol if moves 10%

  # System triggers
  system_triggers:
    latency_threshold_ms: 100  # Halt if latency > 100ms
    error_rate_threshold: 0.05  # Halt if error rate > 5%
    data_gap_threshold: 5  # Halt if data gap > 5 periods

  # Recovery
  recovery:
    auto_resume: false  # Require manual resume
    cooldown_minutes: 30  # 30 min cooldown
    reduced_size_pct: 0.5  # 50% size on resume

# =============================================================================
# POSITION SIZING METHODS
# =============================================================================
position_sizing:
  # Primary method
  primary_method: "volatility_parity"  # fixed_fraction, kelly, volatility_parity, risk_parity

  # Fixed fraction
  fixed_fraction:
    fraction: 0.02  # 2% per trade

  # Kelly criterion
  kelly:
    full_kelly: false
    kelly_fraction: 0.25  # Quarter Kelly
    max_kelly_pct: 0.10  # Cap at 10%

  # Volatility parity
  volatility_parity:
    target_volatility: 0.15
    lookback_period: 20
    vol_floor: 0.05  # Min 5% vol assumption

  # Risk parity
  risk_parity:
    risk_budget_equal: true
    risk_contribution_limit: 0.10  # Max 10% risk per position

  # ATR-based sizing
  atr_sizing:
    enabled: true
    risk_per_trade: 0.01  # 1% risk per trade
    atr_period: 14
    atr_multiplier: 2.0

# =============================================================================
# ORDER RISK CONTROLS
# =============================================================================
order_risk:
  # Pre-trade checks
  pre_trade:
    check_buying_power: true
    check_position_limits: true
    check_sector_limits: true
    check_correlation: true
    check_volatility_regime: true
    check_circuit_breakers: true

  # Order validation
  validation:
    max_order_value: 100000  # Max $100K per order
    max_order_shares: 10000  # Max 10K shares per order
    price_tolerance_pct: 0.05  # 5% price tolerance
    reject_stale_signals: true
    signal_max_age_seconds: 60  # Reject signals > 60s old

  # Execution limits
  execution:
    max_slippage_pct: 0.005  # 0.5% max slippage
    max_partial_fill_wait: 60  # 60s wait for fills
    cancel_unfilled_after: 300  # Cancel after 5 min

# =============================================================================
# GREEK RISK (FOR OPTIONS - FUTURE)
# =============================================================================
greeks_risk:
  enabled: false  # Enable when trading options
  limits:
    max_portfolio_delta: 0.30
    max_portfolio_gamma: 0.05
    max_portfolio_vega: 0.10
    max_portfolio_theta: -0.02

# =============================================================================
# STRESS TESTING PARAMETERS
# =============================================================================
stress_testing:
  # Historical scenarios
  historical_scenarios:
    - name: "2008 Financial Crisis"
      market_drop: -0.50
      volatility_spike: 3.0
    - name: "2020 COVID Crash"
      market_drop: -0.35
      volatility_spike: 4.0
    - name: "Flash Crash 2010"
      market_drop: -0.10
      volatility_spike: 2.0

  # Monte Carlo parameters
  monte_carlo:
    num_simulations: 10000
    time_horizon_days: 20
    confidence_levels: [0.95, 0.99, 0.999]

  # Stress limits
  limits:
    max_stressed_loss: 0.20  # Max 20% loss under stress
    correlation_stress: 0.90  # Assume 90% correlation in stress

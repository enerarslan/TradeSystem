# =============================================================================
# INSTITUTIONAL-GRADE TRADING SYSTEM - GLOBAL CONFIGURATION
# JPMorgan-Level Trading Infrastructure
# =============================================================================

system:
  name: "AlphaTrade Institutional Trading System"
  version: "2.0.0"
  environment: "production"  # development, staging, production
  timezone: "America/New_York"
  log_level: "INFO"

# =============================================================================
# DATA CONFIGURATION
# =============================================================================
data:
  raw_path: "data/raw"
  processed_path: "data/processed"
  features_path: "data/features"
  models_path: "models"

  # Data source settings
  source:
    primary: "local_csv"  # local_csv, polygon, alpaca, bloomberg
    backup: "yfinance"

  # Timeframe settings
  timeframe:
    primary: "15min"
    supported: ["1min", "5min", "15min", "30min", "1H", "4H", "1D"]

  # Data quality settings
  quality:
    min_data_points: 1000
    max_missing_pct: 0.05
    outlier_std_threshold: 5.0
    gap_fill_method: "ffill"  # ffill, bfill, interpolate

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================
database:
  # PostgreSQL + TimescaleDB
  postgres:
    host: "localhost"
    port: 5432
    database: "alphatrade"
    user: "${POSTGRES_USER}"
    password: "${POSTGRES_PASSWORD}"
    pool_size: 10
    max_overflow: 20

  # Redis for caching and queuing
  redis:
    host: "localhost"
    port: 6379
    db: 0
    password: "${REDIS_PASSWORD}"
    max_connections: 50

  # InfluxDB for time-series metrics
  influxdb:
    host: "localhost"
    port: 8086
    database: "trading_metrics"
    retention_policy: "30d"

# =============================================================================
# TRADING CONFIGURATION
# =============================================================================
trading:
  mode: "paper"  # backtest, paper, live

  # Market hours (Eastern Time)
  market_hours:
    pre_market_start: "04:00"
    market_open: "09:30"
    market_close: "16:00"
    after_hours_end: "20:00"

  # Position limits
  position_limits:
    max_positions: 20
    max_position_pct: 0.05  # 5% of portfolio per position
    max_sector_exposure: 0.25  # 25% per sector
    max_correlation_exposure: 0.40

  # Order settings
  orders:
    default_order_type: "limit"
    limit_offset_pct: 0.001  # 0.1% from market price
    max_slippage_pct: 0.005  # 0.5% max slippage
    retry_attempts: 3
    retry_delay_seconds: 1

  # Execution settings
  execution:
    use_twap: true
    twap_intervals: 5
    use_vwap: true
    smart_routing: true
    dark_pool_enabled: false

# =============================================================================
# RISK MANAGEMENT CONFIGURATION
# =============================================================================
risk:
  # Portfolio-level risk
  portfolio:
    initial_capital: 1000000  # $1M
    max_drawdown_pct: 0.10  # 10% max drawdown
    daily_loss_limit_pct: 0.02  # 2% daily loss limit
    weekly_loss_limit_pct: 0.05  # 5% weekly loss limit
    monthly_var_limit: 0.08  # 8% monthly VaR limit

  # Position-level risk
  position:
    max_position_size: 50000  # $50K max per position
    stop_loss_pct: 0.02  # 2% stop loss
    take_profit_pct: 0.04  # 4% take profit
    trailing_stop_pct: 0.015  # 1.5% trailing stop

  # Volatility adjustments
  volatility:
    target_annual_vol: 0.15  # 15% target volatility
    vol_scaling: true
    vol_lookback_days: 20

  # Correlation risk
  correlation:
    max_portfolio_correlation: 0.60
    correlation_lookback_days: 60

  # Circuit breakers
  circuit_breakers:
    enabled: true
    daily_trades_limit: 100
    hourly_trades_limit: 20
    consecutive_losses_halt: 5
    volatility_spike_multiplier: 3.0

# =============================================================================
# FEATURE ENGINEERING CONFIGURATION
# =============================================================================
features:
  # Technical indicators
  technical:
    # Trend indicators
    sma_periods: [5, 10, 20, 50, 100, 200]
    ema_periods: [5, 10, 20, 50, 100, 200]
    macd:
      fast: 12
      slow: 26
      signal: 9
    adx_period: 14

    # Momentum indicators
    rsi_periods: [7, 14, 21]
    stochastic:
      k_period: 14
      d_period: 3
      smooth_k: 3
    williams_r_period: 14
    cci_period: 20
    roc_periods: [5, 10, 20]

    # Volatility indicators
    atr_periods: [7, 14, 21]
    bollinger:
      period: 20
      std_dev: [1.5, 2.0, 2.5]
    keltner:
      ema_period: 20
      atr_period: 10
      multiplier: 2.0
    donchian_period: 20

    # Volume indicators
    obv: true
    vwap: true
    volume_ma_periods: [5, 10, 20]
    mfi_period: 14
    ad_line: true

    # Support/Resistance
    pivot_points: true
    fibonacci_levels: [0.236, 0.382, 0.5, 0.618, 0.786]

  # Advanced features
  advanced:
    # Price action
    candlestick_patterns: true
    price_momentum_crossovers: true

    # Cross-asset features
    sector_momentum: true
    market_regime: true
    correlation_features: true

    # Statistical features
    z_score_lookback: 20
    percentile_ranks: true
    rolling_skew_kurtosis: true

    # Microstructure features
    bid_ask_imbalance: false  # Requires L2 data
    order_flow: false  # Requires L2 data

  # Feature selection
  selection:
    method: "importance"  # importance, correlation, pca
    max_features: 100
    min_importance: 0.001
    correlation_threshold: 0.95

# =============================================================================
# ML MODEL CONFIGURATION
# =============================================================================
ml:
  # Target variable
  target:
    type: "classification"  # classification, regression
    lookahead_periods: 4  # Predict 4 periods ahead (1 hour for 15min data)
    threshold_pct: 0.005  # 0.5% threshold for classification

  # Training settings
  training:
    train_test_split: 0.8
    validation_split: 0.1
    walk_forward:
      enabled: true
      train_periods: 2520  # ~6 months of 15-min bars
      test_periods: 420  # ~1 month of 15-min bars
      step_periods: 420  # Retrain monthly

  # Model ensemble
  models:
    xgboost:
      enabled: true
      weight: 0.35
      params:
        n_estimators: 500
        max_depth: 6
        learning_rate: 0.05
        subsample: 0.8
        colsample_bytree: 0.8
        min_child_weight: 3
        gamma: 0.1
        reg_alpha: 0.1
        reg_lambda: 1.0

    lightgbm:
      enabled: true
      weight: 0.35
      params:
        n_estimators: 500
        max_depth: 6
        learning_rate: 0.05
        num_leaves: 31
        subsample: 0.8
        colsample_bytree: 0.8
        min_child_samples: 20
        reg_alpha: 0.1
        reg_lambda: 1.0

    catboost:
      enabled: true
      weight: 0.15
      params:
        iterations: 500
        depth: 6
        learning_rate: 0.05
        l2_leaf_reg: 3.0

    neural_network:
      enabled: true
      weight: 0.15
      architecture:
        type: "transformer"  # mlp, lstm, transformer
        hidden_layers: [256, 128, 64]
        dropout: 0.3
        batch_norm: true
        attention_heads: 4

  # Hyperparameter optimization
  optimization:
    method: "optuna"  # grid, random, optuna, hyperopt
    n_trials: 100
    cv_folds: 3  # Updated: 3-fold recommended for 11% embargo (effective test: 20.3%)
    scoring: "f1_weighted"

# =============================================================================
# STRATEGY CONFIGURATION
# =============================================================================
strategy:
  # Active strategies
  active_strategies:
    - "momentum"
    - "mean_reversion"
    - "ml_ensemble"
    - "pairs_trading"

  # Strategy weights for ensemble
  weights:
    momentum: 0.25
    mean_reversion: 0.20
    ml_ensemble: 0.40
    pairs_trading: 0.15

  # Momentum strategy
  momentum:
    lookback_periods: [5, 10, 20]
    entry_threshold: 0.7  # RSI > 70 or < 30
    exit_threshold: 0.5
    trend_filter: true
    volume_confirmation: true

  # Mean reversion strategy
  mean_reversion:
    zscore_entry: 2.0
    zscore_exit: 0.5
    lookback_period: 20
    half_life_max: 20

  # ML ensemble strategy
  ml_ensemble:
    min_confidence: 0.60
    confirmation_required: 2  # Minimum models agreeing

  # Pairs trading
  pairs_trading:
    cointegration_pvalue: 0.05
    zscore_entry: 2.0
    zscore_exit: 0.5
    lookback_period: 60

# =============================================================================
# BROKER CONFIGURATION
# =============================================================================
broker:
  # Primary broker
  primary: "alpaca"

  # Alpaca settings
  alpaca:
    api_key: "${ALPACA_API_KEY}"
    api_secret: "${ALPACA_API_SECRET}"
    base_url: "https://paper-api.alpaca.markets"  # Paper trading
    data_url: "https://data.alpaca.markets"
    websocket_url: "wss://stream.data.alpaca.markets"

  # Interactive Brokers settings
  ibkr:
    host: "127.0.0.1"
    port: 7497  # Paper: 7497, Live: 7496
    client_id: 1
    account: "${IBKR_ACCOUNT}"

# =============================================================================
# MONITORING CONFIGURATION
# =============================================================================
monitoring:
  # Prometheus metrics
  prometheus:
    enabled: true
    port: 9090

  # Grafana dashboards
  grafana:
    enabled: true
    port: 3000

  # Alerting
  alerts:
    enabled: true
    channels:
      slack:
        webhook_url: "${SLACK_WEBHOOK_URL}"
        channel: "#trading-alerts"
      email:
        smtp_server: "smtp.gmail.com"
        smtp_port: 587
        sender: "${ALERT_EMAIL}"
        recipients: ["${ALERT_EMAIL}"]

  # Alert thresholds
  thresholds:
    drawdown_warning: 0.05  # 5% drawdown warning
    drawdown_critical: 0.08  # 8% drawdown critical
    daily_loss_warning: 0.01  # 1% daily loss warning
    position_concentration: 0.10  # 10% single position warning
    latency_warning_ms: 50
    latency_critical_ms: 100

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================
logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

  handlers:
    console:
      enabled: true
      level: "INFO"

    file:
      enabled: true
      level: "DEBUG"
      path: "logs/trading.log"
      max_bytes: 10485760  # 10MB
      backup_count: 10

    database:
      enabled: true
      level: "WARNING"

  # Audit logging (for compliance)
  audit:
    enabled: true
    path: "logs/audit.log"
    include_orders: true
    include_positions: true
    include_pnl: true
